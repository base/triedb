name: PR

on:
  push:
    branches: [ "main" ]
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        profile: [dev, release]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: cargo build --verbose --profile=${{ matrix.profile }}

  format:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@nightly
      with:
        components: rustfmt
    - name: Format
      run: |
        cargo +nightly fmt --all -- --check
        if [ $? -ne 0 ]; then
          echo "::error::Formatting check failed. Please run 'make format' locally and commit the changes."
          cargo +nightly fmt --all -- --check
          exit 1
        fi

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Lint
      run: cargo clippy --all-targets -- --deny=warnings

  unit-tests:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        profile: [dev, release]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    - name: Run unit tests
      run: |
        make unit-tests cargo_flags='--verbose --profile=${{ matrix.profile }}'

  integration-tests:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        profile: [dev, release]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    - name: Run integration tests
      run:
        make integration-tests cargo_flags=--profile=${{ matrix.profile }} test_flags=--nocapture
